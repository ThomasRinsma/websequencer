<!DOCTYPE html>
<html>
<head>
<title>Tablurp v2.0</title>
<style type="text/css">
#wrapper {
	max-width: 800px;
}

#bpm {
	width: 40px;
}

#measure {
	width: 40px;
}

textarea {
	width: 400px;
}

#outputText {
	font-family: monospace;
	font-size: 9pt;
}

</style>
<script type="text/javascript" src="Tone.min.js"></script>
<script type="text/javascript">
var clock = 0;
var nextPlay = 0;
var noteIdx = 0;
var playing = false;
var bpm;
var interval;


// Note.js players
var synthPlayer;
var clickPlayer;

// the current melody and rhythm, as arrays
var melodyArr = [];
var rhythmArr = [];

function initialSetup() {
	// load click sound
	clickPlayer = new Tone.Player("sounds/snare.wav").toMaster();
	synthPlayer = new Tone.Synth().toMaster();

	// grab preset from link
	if (window.location.hash) {
		var preset = decodeURIComponent(window.location.hash.substring(1));
		var parts = preset.split('-');

		// Update the field values
		document.getElementById('rhythm').value = parts[0];
		document.getElementById('melody').value = parts[1];

		updateContext();
	}
}

// Helper function
function playNote(note, sixteenths) {
	// ends with num? then don't add number
	if (!"1234567890".includes(note.slice(-1))) {
		// Doesn't include num, so add number based on case
		if ("ABCDEFG".includes(note[0])) {
			// upper case
			note = note + "4";
		} else {
			// lower case
			note = note + "3";
		}
	}

	synthPlayer.triggerAttackRelease(note, "0:0:" + sixteenths);
}

function clockSixteenth() {

	if (clock % 4 == 0) {
		// Play click
		clickPlayer.start();		
	}

	console.log("clock = " + clock + ", nextplay = " + nextPlay);
	if (clock >= nextPlay) {
		// Play the note
		note = melodyArr[noteIdx % melodyArr.length];
		length = rhythmArr[noteIdx % rhythmArr.length];
		playNote(note, length);
		noteIdx++;

		// Print for debug
		document.getElementById('outputText').innerHTML += "["+note+" "+length+"]<br/>";
		
		console.log("length = " + length);
		nextPlay = clock + (length * 1.0);
	}

	clock++
}

function playClick() {
	
}

// Grab and set new speed
function setBpm() {
	bpm = document.getElementById('bpm').value;

	// Set the bpm for Tone.js
	Tone.Transport.bpm.value = bpm;
}

// Parse text into list of notes, split on comma
function parseMelody(melodyStr) {
	tokens = melodyStr.split(",");

	melodyArr = [];
	for (i = 0; i < tokens.length; ++i) {
		token = tokens[i].trim()
		if (token.length > 0) {
			melodyArr.push(token);
		}
	}

	console.log("melody = " + melodyArr);
}

// Parse text into list of lengths, split on space
function parseRhythm(melodyStr) {
	tokens = melodyStr.split(",");

	rhythmArr = [];
	for (i = 0; i < tokens.length; ++i) {
		token = tokens[i].trim()
		if (token.length > 0) {
			rhythmArr.push(token * 1.0);
		}
	}

	console.log("rhythm = " + rhythmArr);
	// TODO: data validation
}


// Grab newly entered rhythm and/or melody values
function updateContext() {
	r = document.getElementById('rhythm').value;
	m = document.getElementById('melody').value;
	
	// Parse strings into lists
	parseRhythm(r);
	parseMelody(m);

	// Update url hash
	window.location.hash = '#' + encodeURIComponent(rhythmArr.join(',') + '-' + melodyArr.join(','));

	// Update infos
	rLen = rhythmArr.reduce((a, b) => a + b, 0);
	document.getElementById('rhythmLength').innerHTML = rLen;

	mLen = melodyArr.length;
	document.getElementById('melodyLength').innerHTML = mLen;
}

function play() {
	if (playing) {
		return;
	}

	playing = true;
	clock = 0;
	nextPlay = 0;
	noteIdx = 0;
	setBpm();
	updateContext();

	clearInterval(interval);
	interval = window.setInterval(clockSixteenth, ((60.0 / bpm) * 1000.0) / 4.0);
}

function stop() {
	playing = false;

	clearInterval(interval);
}




</script>
</head>
<body onload="initialSetup()">
<div id="wrapper">

<fieldset>
	<table>
		<legend>Inputs</legend>
		<tr>
			<td><label>bpm</label></td>
			<td><input type="number" id="bpm" value="120" oninput="setBpm()"></td>
		</tr>
<!-- 		<tr>
			<td><label>measure</label></td>
			<td><input type="number" id="measure" value="16">/16</td>
		</tr> -->
		<tr>
			<td><label>rhythm</label></td>
			<td><textarea id="rhythm" oninput="updateContext()"></textarea></td>
		</tr>
		<tr>
			<td><label>melody</label></td>
			<td><textarea id="melody" oninput="updateContext()"></textarea></td>
		</tr>
		<tr>
			<td colspan="2"><hr /></td>
		</tr>
		<tr>
			<td>rhythm length:</td>
			<td><span id="rhythmLength"></span>/16</td>
		</tr>
		<tr>
			<td>melody length:</td>
			<td><span id="melodyLength"></span> notes</td>
		</tr>
	</table>
</fieldset>

<fieldset>
	<legend>Output</legend>

	<button onclick="play()">play</button>
	<button onclick="stop()">stop</button>
	<button onclick="document.getElementById('outputText').innerHTML = ''">[clear output]</button>
	<hr />

	<div id="outputText"></div>
</fieldset>

</div>
</body>
</html>